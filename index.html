<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Civil Engineering – Oblique Triangles (Sine & Cosine Rule)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root{
      --accent:#6a5cff;
      --accent2:#00c2ff;
      --ink:#0f172a;
      --muted:#55607a;
      --success:#2e7d32;
      --error:#e53935;
      --surface:#ffffff;
      --field-w:11rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      margin:0;color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #dfe8ff, transparent 60%),
        radial-gradient(1200px 600px at 110% 10%, #ccfbff, transparent 60%),
        linear-gradient(180deg,#f5f8ff 0%, #f0fbff 50%, #eef3ff 100%);
    }
    h1{
      margin:0.7rem 0 0.4rem;text-align:center;
      font-size:1.6rem;font-weight:900;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;
      letter-spacing:.2px
    }
    p.lede{max-width:980px;margin:0.2rem auto 0.6rem;text-align:center;color:#1f2a44}

    .logo{position:absolute;top:10px;left:10px;width:110px;height:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.15)}

    /* Top bar */
    .topbar{
      max-width:980px;margin:0.15rem auto 0.65rem;display:flex;gap:0.6rem;
      justify-content:space-between;align-items:center;padding:0 0.6rem
    }
    .badge{
      background:#fff;border:1px solid rgba(106,92,255,.25);border-radius:14px;
      padding:0.5rem 0.7rem;font-weight:800;min-width:120px;text-align:center;
      box-shadow:0 3px 10px rgba(106,92,255,.08)
    }
    .badge small{display:block;font-weight:600;color:var(--muted);margin-top:2px;font-size:.82rem}
    .top-actions{display:flex;gap:0.45rem;align-items:center}
    .fsBtn{
      border:1px solid rgba(0,194,255,.5);background:linear-gradient(180deg,#ffffff,#f3fcff);
      border-radius:12px;padding:.55rem .8rem;font-weight:900;cursor:pointer;color:#0b3d4a;
      box-shadow:0 3px 10px rgba(0,194,255,.15)
    }
    .fsBtn:hover{background:#ecfbff}

    /* Card */
    .card{
      max-width:980px;margin:0.25rem auto;background:var(--surface);border-radius:16px;
      border:2px solid rgba(106,92,255,.35);
      box-shadow:0 12px 30px rgba(106,92,255,.12), 0 6px 14px rgba(0,0,0,.06);
      padding:0.95rem
    }
    .titleRow{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem}
    .qTitle{font-size:1.15rem;font-weight:900;color:#2c3477;margin:0.1rem 0}
    .qMeta{color:var(--muted);font-size:.95rem}

    .statement{font-size:1.5rem;margin:0.55rem 0 0.7rem;line-height:1.35}
    .statement b{font-weight:900}

    details{border:1px solid rgba(106,92,255,.3);border-radius:12px;margin:0.5rem 0;background:#fbfcff}
    summary{cursor:pointer;font-weight:900;color:#2c3477;padding:0.6rem 0.8rem;list-style:none}
    summary::-webkit-details-marker{display:none}
    .hint{padding:0 0.9rem 0.85rem;font-size:1rem;color:#1f2a44}

    /* EXTRA spacing in the refresher formulas (not squashed) */
    #globalHint .hint ul{margin:0;padding-left:1.2rem;line-height:1.7}
    #globalHint .hint li{margin:.48rem 0}

    /* Inputs */
    .io{display:grid;gap:0.8rem;margin-top:0.5rem}
    .row{display:grid;grid-template-columns:1.2fr auto auto auto 1fr;align-items:center;gap:.6rem}
    .row label{font-weight:900;color:#1f2a44;font-size:1.05rem}
    .unit{
      background:linear-gradient(180deg,#eef4ff,#f7fbff);
      border:1px solid rgba(0,194,255,.35);
      color:#173a56;border-radius:10px;padding:0.35rem 0.6rem;font-weight:900;min-width:6.5rem;text-align:center
    }
    .num{
      width:var(--field-w);text-align:center;border:1px solid rgba(106,92,255,.45);
      border-radius:10px;font-size:1.02rem;padding:.48rem .4rem;background:linear-gradient(180deg,#ffffff,#f6f7ff);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.06)
    }
    .num:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(106,92,255,.18)}

    /* Markers & feedback */
    .marker{font-size:1.45rem;font-weight:900;min-width:1.9rem;text-align:center}
    .ok{color:var(--success); animation:pop .25s ease-out}
    .no{color:var(--error)}
    @keyframes pop { 0%{transform:scale(0.85)} 100%{transform:scale(1)} }
    .feedback{font-size:0.95rem;color:#1f2a44}
    .feedback .ans{font-weight:900}

    /* Controls */
    .controls{display:flex;justify-content:center;gap:.6rem;margin-top:0.75rem;flex-wrap:wrap}
    button.primary{
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff;border:none;border-radius:12px;padding:.7rem 1.2rem;font-weight:900;cursor:pointer;
      box-shadow:0 8px 18px rgba(106,92,255,.25)
    }
    button.secondary{
      background:#111827;color:#fff;border:none;border-radius:12px;padding:.7rem 1.2rem;font-weight:900;cursor:pointer
    }
    button.ghost{
      background:linear-gradient(180deg,#ffffff,#f7f9ff);border:1px solid rgba(17,24,39,.25);
      border-radius:12px;padding:.6rem 1rem;font-weight:900;cursor:pointer;color:#111827
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    #progress{font-weight:900;text-align:center;color:#111827;margin:0.15rem 0 0.6rem}

    /* Start modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:999}
    .panel{
      background:linear-gradient(180deg,#ffffff,#f7f8ff);
      border-radius:16px;max-width:780px;width:100%;
      box-shadow:0 18px 40px rgba(17,24,39,.25);border:2px solid rgba(106,92,255,.35)
    }
    .panel header{padding:0.9rem 1rem;border-bottom:1px solid rgba(106,92,255,.25)}
    .panel header h2{margin:0;color:#2c3477}
    .panel .content{padding:1rem;display:grid;gap:0.9rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem}
    .field{display:grid;gap:0.35rem}
    .field input[type=text], .field input[type=number], .field select{
      padding:0.55rem .6rem;border:1px solid rgba(106,92,255,.4);border-radius:10px;background:#fff
    }
    .choiceRow{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid rgba(106,92,255,.45);padding:.35rem .7rem;border-radius:999px;cursor:pointer;font-weight:900;background:#fff}
    .pill input{margin-right:.35rem}
    .panel footer{display:flex;justify-content:space-between;align-items:center;padding:0.85rem 1rem;border-top:1px solid rgba(106,92,255,.25)}
    .muted{color:var(--muted);font-size:.95rem}

    /* End screen */
    #endCard{max-width:820px;margin:1rem auto;padding:1rem;border-radius:14px;background:#fff;border:2px solid #2e7d32;display:none}
    #endCard h3{margin-top:0;color:#1e7a31}
    .wellDone{display:inline-block;background:#eaf7ec;border:1px solid #b9e2bf;color:#1e7a31;padding:.25rem .5rem;border-radius:8px;font-weight:900}

    /* Figures (SVG) – larger */
    .fig{max-width:980px;width:100%;height:auto;display:block;margin:.5rem auto;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08);background:#fff}
  </style>
</head>
<body>
  <img src="https://lirp.cdn-website.com/b085c470/dms3rep/multi/opt/Bucks%2BCollege%2BGroup-e5af1b68-1920w.jpg"
       alt="Bucks College Group logo" class="logo">

  <h1>Oblique Triangles — Sine Rule &amp; Cosine Rule (Civil Engineering)</h1>
  <p class="lede">Non‑right geometry for stays, set‑out and offsets. <strong>Triangles are not right‑angled.</strong> Symbols show angle positions only. All answers to <strong>2 dp</strong>.</p>

  <div class="topbar">
    <div style="display:flex;gap:0.6rem;align-items:center">
      <div class="badge" id="who"><span id="whoName">Student</span><small>Participant</small></div>
      <div class="badge" id="mode"><span id="modeTxt">Timed</span><small>Mode</small></div>
      <div class="badge" id="timer"><span id="timeTxt">—</span><small>Timer</small></div>
      <div class="badge" id="scoreTop"><span id="scoreTopVal">0 / 0</span><small>Score</small></div>
    </div>
    <div class="top-actions">
      <button class="fsBtn" id="fsBtn" title="Toggle full screen">⛶ Full screen</button>
    </div>
  </div>

  <!-- Quick refresher only -->
  <div class="card" id="globalHint">
    <details open>
      <summary>Quick refresher (formulas)</summary>
      <div class="hint">
        <ul>
          <li><strong>Sine Rule:</strong> \(\displaystyle \frac{a}{\sin A}=\frac{b}{\sin B}=\frac{c}{\sin C}\).</li>
          <li><strong>Cosine Rule:</strong> \(\displaystyle
            a^2=b^2+c^2-2bc\cos A,\quad
            b^2=c^2+a^2-2ca\cos B,\quad
            c^2=a^2+b^2-2ab\cos C.\)</li>
          <li><strong>Rearrange as needed.</strong> Round final answers to <strong>2 dp</strong>.</li>
        </ul>
      </div>
    </details>
  </div>

  <!-- Question card -->
  <div class="card" id="qCard" style="display:none">
    <div class="titleRow">
      <div>
        <div class="qTitle" id="qTitle">Question</div>
        <div class="qMeta">Use the to‑scale diagram. Enter each requested value to <strong>2 dp</strong>, then click <strong>Check</strong>.</div>
      </div>
      <div class="qMeta" id="progress">Question 1</div>
    </div>

    <div class="statement" id="statement"></div>

    <details id="whyBox">
      <summary>Why this matters (click to expand)</summary>
      <div class="hint" id="whyHtml"></div>
    </details>

    <div class="io" id="io"></div>

    <div class="controls">
      <button class="primary" id="checkBtn">Check</button>
      <button class="ghost" id="nextBtn" disabled>Next</button>
      <button class="secondary" id="newBtn">New questions</button>
    </div>
  </div>

  <!-- End summary -->
  <div id="endCard">
    <h3>Summary</h3>
    <p class="wellDone" id="endMsg"></p>
    <ul>
      <li><strong>Name:</strong> <span id="sumName"></span></li>
      <li><strong>Mode:</strong> <span id="sumMode"></span></li>
      <li><strong>Score:</strong> <span id="sumScore"></span></li>
      <li><strong>Time used:</strong> <span id="sumTime"></span></li>
    </ul>
    <div style="display:flex;gap:.6rem;justify-content:center;margin-top:.4rem">
      <button class="secondary" id="restartBtn">Restart</button>
    </div>
  </div>

  <!-- Start menu modal -->
  <div class="modal" id="startModal">
    <div class="panel">
      <header><h2>Start Worksheet</h2></header>
      <div class="content">
        <div class="field">
          <label for="nameInput"><strong>Your name</strong></label>
          <input id="nameInput" type="text" placeholder="Type your name…" autocomplete="name">
        </div>

        <div class="field">
          <label><strong>Mode</strong></label>
          <div class="choiceRow">
            <label class="pill"><input type="radio" name="mode" value="timed" checked>Timed</label>
            <label class="pill"><input type="radio" name="mode" value="target">Target</label>
          </div>
        </div>

        <div class="grid2">
          <div class="field" id="timedField" style="display:block">
            <label><strong>Time limit</strong></label>
            <div class="choiceRow">
              <label class="pill"><input type="radio" name="tlimit" value="600">10 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="1200" checked>20 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="1800">30 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="0">Unlimited</label>
            </div>
          </div>

          <div class="field" id="targetField" style="display:none">
            <label for="targetInput"><strong>Target (correct answers to finish)</strong></label>
            <input id="targetInput" type="number" min="1" max="1000" step="1" value="10">
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="qtyInput"><strong>Total questions (per set)</strong></label>
            <select id="qtyInput">
              <option value="8">8</option>
              <option value="10" selected>10</option>
              <option value="12">12</option>
              <option value="15">15</option>
            </select>
          </div>
          <div class="field">
            <div class="muted">Diagrams are to scale. Symbols show angle positions only (values are in the text). Answers to <strong>2 dp</strong>.</div>
          </div>
        </div>
      </div>
      <footer>
        <span class="muted">You can generate a fresh random set any time.</span>
        <div>
          <button class="primary" id="startBtn">Start worksheet</button>
        </div>
      </footer>
    </div>
  </div>

  <div id="errBanner" style="display:none;position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
    background:#fee;border:2px solid #e53935;color:#7f1d1d;padding:.5rem .8rem;border-radius:10px;font-weight:800;z-index:2000"></div>
  <noscript><div style="margin:1rem auto;max-width:980px;color:#b91c1c;background:#fee;border:2px solid #e11d48;padding:.6rem;border-radius:12px;font-weight:800">This worksheet needs JavaScript enabled.</div></noscript>

<script>
'use strict';

window.addEventListener('error', (e) => {
  const b = document.getElementById('errBanner');
  b.textContent = 'Error: ' + (e.message || 'Unknown script error');
  b.style.display = 'block';
});

window.addEventListener('DOMContentLoaded', () => {

  /* ========= Helpers ========= */
  const rnd=(m,M)=>Math.floor(Math.random()*(M-m+1))+m;
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const rndf=(min,max,dp=2)=>+((Math.random()*(max-min)+min).toFixed(dp));
  const round2=x=>Math.round((+x + Number.EPSILON)*100)/100;
  const to2=x=>isFinite(x)?round2(x).toFixed(2):'—';
  const parseNum = (input) => {
    const raw = (typeof input === 'string' ? input : (input?.value ?? '')).toString().trim().replace(',','.');
    const x = parseFloat(raw);
    return isFinite(x)?x:NaN;
  };
  const deg = r=>r*180/Math.PI;
  const rad = d=>d*Math.PI/180;
  // accept within ±0.09 (quietly)
  const within09=(a,b)=>isFinite(a)&&isFinite(b)&&Math.abs(a-b)<=0.09+1e-9;
  const secsToMMSS=s=>{const m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`;};
  const unit = (u) => ({ m:'m', deg:'°' }[u]||u);
  const lines = arr => arr.join('<br>');

  /* ========= SVG & Robust Layout ========= */
  function figWrap(viewW, viewH, inner){
    return `<svg class="fig" viewBox="0 0 ${viewW} ${viewH}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="diagram">
      <defs>
        <style>
          .tri{stroke:#1f2a44;stroke-width:2}
          .tri.c1{fill:rgba(106,92,255,.24)}
          .tri.c2{fill:rgba(0,194,255,.22)}
          .tri.c3{fill:rgba(255,159,67,.22)}
          .tri.c4{fill:rgba(34,197,94,.22)}
          .tri.c5{fill:rgba(236,72,153,.22)}
          .tri.c6{fill:rgba(14,165,233,.22)}
          .tri.c7{fill:rgba(250,204,21,.22)}

          .aux{stroke:#334155;stroke-dasharray:6 4;stroke-width:2;fill:none}
          .tick{stroke:#1f2a44;stroke-width:2}
          .dim{
            font:700 21px/1 Inter, system-ui;
            fill:#0f172a;
            paint-order:stroke fill; stroke:#ffffff; stroke-width:3px;
          }
          .ang{
            font:800 26px/1.1 Inter, system-ui;
            fill:#1e2a66;
            paint-order:stroke fill; stroke:#ffffff; stroke-width:3.5px;
          }
          .label{font:800 16px/1 Inter, system-ui; fill:#2c3477; paint-order:stroke fill; stroke:#fff; stroke-width:1.5px;}
        </style>
      </defs>
      ${inner}
    </svg>`;
  }

  // Compute raw coords (A=0,0; B=c,0; C=(cx,cy))
  function coreCoords(a,b,c){
    const cx = (b*b + c*c - a*a)/(2*c);
    const h2 = Math.max(1e-9, b*b - cx*cx);
    const cy = Math.sqrt(h2);
    return {cx, cy};
  }

  function layoutOblique(a,b,c, w=980, h=720, margins={left:160,right:160,top:120,baseBottom:220}){
    const {cx, cy} = coreCoords(a,b,c);
    const minX = Math.min(0, c, cx);
    const maxX = Math.max(0, c, cx);
    const rawWidth = maxX - minX;

    const availW = Math.max(240, w - margins.left - margins.right);
    const availH = Math.max(180, h - margins.top - margins.baseBottom);

    const s = Math.min(availW/rawWidth, availH/cy);

    const xShift = margins.left + (availW - rawWidth*s)/2 - minX*s;
    const yTop = margins.top + (availH - cy*s)/2;
    const yBase = yTop + cy*s;

    const A = [xShift + 0,     yBase];
    const B = [xShift + c*s,   yBase];
    const C = [xShift + cx*s,  yTop];

    return { A, B, C, w, h };
  }

  const insetFor = lenPx => clamp(lenPx*0.12, 12, 30);

  function dimBase(A,B,label,w,h){
    const [x0,y0]=A, [x1,y1]=B;
    const L = Math.hypot(x1-x0,y1-y0);
    const inset=insetFor(L), off=68, ext=34, dimY=y0+off;
    return `
      <line x1="${x0}" y1="${y0}" x2="${x0}" y2="${dimY+ext}" class="aux"/>
      <line x1="${x1}" y1="${y1}" x2="${x1}" y2="${dimY+ext}" class="aux"/>
      <line x1="${x0+inset}" y1="${dimY}" x2="${x1-inset}" y2="${dimY}" class="aux"/>
      <line x1="${x0+inset}" y1="${dimY-7}" x2="${x0+inset}" y2="${dimY+7}" class="tick"/>
      <line x1="${x1-inset}" y1="${dimY-7}" x2="${x1-inset}" y2="${dimY+7}" class="tick"/>
      ${label?`<text x="${(x0+x1)/2}" y="${dimY+22}" text-anchor="middle" dominant-baseline="hanging" class="dim">${label}</text>`:''}
    `;
  }

  function dimAlongEdge(P,Q,G,label,w,h){
    if(!label) return '';
    const margin=12;
    const [px,py]=P, [qx,qy]=Q;
    const dx=qx-px, dy=qy-py;
    const L = Math.hypot(dx,dy)||1; const tx=dx/L, ty=dy/L;

    let nx=-ty, ny=tx;
    const mx=(px+qx)/2, my=(py+qy)/2;
    if(nx*(mx-G[0]) + ny*(my-G[1]) < 0){ nx=-nx; ny=-ny; }

    const inset=insetFor(L), off=44, ext=32;

    function pack(nx,ny){
      const P1x=px + nx*off + tx*inset, P1y=py + ny*off + ty*inset;
      const P2x=qx + nx*off - tx*inset, P2y=qy + ny*off - ty*inset;
      const EA1x1=px + nx*2, EA1y1=py + ny*2;
      const EA1x2=px + nx*(off+ext), EA1y2=py + ny*(off+ext);
      const EA2x1=qx + nx*2, EA2y1=qy + ny*2;
      const EA2x2=qx + nx*(off+ext), EA2y2=qy + ny*(off+ext);
      const midx=(P1x+P2x)/2, midy=(P1y+P2y)/2;
      let angle = Math.atan2(P2y-P1y, P2x-P1x)*180/Math.PI;
      if(angle>90) angle-=180;
      if(angle<-90) angle+=180;
      const labOff=22;
      const lx = midx + nx*labOff, ly = midy + ny*labOff;
      return {P1x,P1y,P2x,P2y,EA1x1,EA1y1,EA1x2,EA1y2,EA2x1,EA2y1,EA2x2,EA2y2,lx,ly,angle};
    }

    let d=pack(nx,ny);
    const inside = (d)=>(
      d.lx>margin && d.ly>margin && d.lx<w-margin && d.ly<h-margin &&
      d.P1x>margin && d.P1y>margin && d.P2x>margin && d.P2y>margin &&
      d.P1x<w-margin && d.P1y<h-margin && d.P2x<w-margin && d.P2y<h-margin &&
      d.EA1x2>margin && d.EA1y2>margin && d.EA2x2>margin && d.EA2y2>margin &&
      d.EA1x2<w-margin && d.EA1y2<h-margin && d.EA2x2<w-margin && d.EA2y2<h-margin
    );
    if(!inside(d)){ nx=-nx; ny=-ny; d=pack(nx,ny); }

    return `
      <line x1="${d.EA1x1}" y1="${d.EA1y1}" x2="${d.EA1x2}" y2="${d.EA1y2}" class="aux"/>
      <line x1="${d.EA2x1}" y1="${d.EA2y1}" x2="${d.EA2x2}" y2="${d.EA2y2}" class="aux"/>
      <line x1="${d.P1x}" y1="${d.P1y}" x2="${d.P2x}" y2="${d.P2y}" class="aux"/>
      <text x="${d.lx}" y="${d.ly}" text-anchor="middle" dominant-baseline="middle"
        class="dim" transform="rotate(${d.angle} ${d.lx} ${d.ly})">${label}</text>
    `;
  }

  function angleSymbol(V, V1, V2, sym){
    const [vx,vy]=V, [v1x,v1y]=V1, [v2x,v2y]=V2;
    const u1x=v1x-vx, u1y=v1y-vy, u2x=v2x-vx, u2y=v2y-vy;
    const L1=Math.hypot(u1x,u1y)||1, L2=Math.hypot(u2x,u2y)||1;
    let bx=u1x/L1 + u2x/L2, by=u1y/L1 + u2x/L2;
    const bL=Math.hypot(bx,by)||1; bx/=bL; by/=bL;
    const d=28;
    const lx = vx + bx*d, ly = vy + by*d;
    return `<text x="${lx}" y="${ly}" class="ang">${sym}</text>`;
  }
  function pickTriClass(){ return 'c' + rnd(1,7); }

  function svgOblique(a,b,c, labels, caption='Oblique triangle', triClass='c1'){
    const w=980, h=720;
    const {A, B, C} = layoutOblique(a,b,c,w,h,{left:160,right:160,top:120,baseBottom:230});
    const G=[(A[0]+B[0]+C[0])/3, (A[1]+B[1]+C[1])/3];

    const inner=`
      <text x="${w/2}" y="30" text-anchor="middle" class="label">${caption}</text>
      <polygon points="${A[0]},${A[1]} ${B[0]},${B[1]} ${C[0]},${C[1]}" class="tri ${triClass}"/>

      ${angleSymbol(A, B, C, 'A')}
      ${angleSymbol(B, A, C, 'B')}
      ${angleSymbol(C, A, B, 'C')}

      ${dimBase(A,B, labels.c, w, h)}
      ${dimAlongEdge(A,C,G, labels.b, w, h)}
      ${dimAlongEdge(B,C,G, labels.a, w, h)}
    `;
    return figWrap(w,h,inner);
  }

  /* ========= IO builder ========= */
  function buildIORows(parts){
    const io = document.getElementById('io');
    io.innerHTML = '';
    parts.forEach((p,i) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <label>${p.prompt}</label>
        <input class="num" id="ans-${i}" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g. 12.34">
        <span class="unit">${unit(p.unit)}</span>
        <span class="marker" id="mark-${i}"></span>
        <span class="feedback" id="fb-${i}"></span>
      `;
      io.appendChild(row);
    });
    io.querySelectorAll('input.num').forEach(inp=>{
      inp.addEventListener('blur', ()=>{
        const x = parseNum(inp.value);
        if(isFinite(x)) inp.value = to2(x);
      });
    });
  }

  /* ========= Triangle generation ========= */

  function notRight(A,B,C){
    return Math.abs(A-90)>0.8 && Math.abs(B-90)>0.8 && Math.abs(C-90)>0.8;
  }

  function randomTriangle(){
    // Make a non-right oblique triangle with reasonable angles and sides
    for(let tries=0; tries<200; tries++){
      const A = rndf(28, 118, 2);
      const B = rndf(28, 118, 2);
      const C = round2(180 - A - B);
      if(C < 28 || C > 118) continue;
      if(!notRight(A,B,C)) continue;

      const c = rndf(10, 32, 2);                  // choose base to scale the figure
      const k = c / Math.sin(rad(C));             // common ratio a/sinA = b/sinB = c/sinC
      const a = k * Math.sin(rad(A));
      const b = k * Math.sin(rad(B));

      if(a>4 && b>4 && a<60 && b<60) return {A,B,C,a,b,c,k};
    }
    // deterministic fallback (should not hit)
    const A=60, B=50, C=70, c=20, k=c/Math.sin(rad(C));
    return {A,B,C,a:k*Math.sin(rad(A)), b:k*Math.sin(rad(B)), c, k};
  }

  // SSA uniqueness guard: given angle X with opposite side x and another side y
  function ssaUnique(angleDeg, oppSide, otherSide){
    if(angleDeg > 90) return true;          // obtuse -> unique
    if(Math.abs(angleDeg-90)<0.8) return false; // avoid near-right triangles altogether
    // For a valid triangle from our generator, oppSide <= otherSide can cause ambiguity when angle is acute.
    // Avoid two-solution region by insisting oppSide >= otherSide.
    return oppSide >= otherSide;
  }

  function triangleFor(predicate){
    for(let i=0;i<400;i++){
      const T=randomTriangle();
      if(predicate(T)) return T;
    }
    // Last-resort tweak (rare)
    for(let j=0;j<200;j++){
      let T=randomTriangle();
      T.A = rndf(100, 130, 2);
      T.C = round2(180 - T.A - T.B);
      if(T.C > 28 && T.C < 118 && notRight(T.A,T.B,T.C)){
        const c = rndf(10, 32, 2);
        const k = c/Math.sin(rad(T.C));
        T.a = k*Math.sin(rad(T.A)); T.b = k*Math.sin(rad(T.B)); T.c = c; T.k=k;
        if(predicate(T)) return T;
      }
    }
    return randomTriangle();
  }

  /* ========= Scenario sets (21 engineering contexts) ========= */

  // Given/asked sets per your list
  const scenarioDefs = [
    // SSS
    {num:1, givens:['a','b','c'], asks:['A','B']},
    {num:2, givens:['a','b','c'], asks:['B','C']},
    {num:3, givens:['a','b','c'], asks:['A','C']},
    // SAS
    {num:4, givens:['a','b','C'], asks:['c','A']},
    {num:5, givens:['b','c','A'], asks:['a','B']},
    {num:6, givens:['a','c','B'], asks:['b','C']},
    // AAS/ASA with one side
    {num:7, givens:['A','B','c'], asks:['C','a']},
    {num:8, givens:['B','C','a'], asks:['A','b']},
    {num:9,  givens:['A','C','b'], asks:['B','c']},
    {num:10, givens:['A','B','a'], asks:['C','b']},
    {num:11, givens:['A','C','a'], asks:['B','c']},
    {num:12, givens:['B','C','b'], asks:['A','a']},
    {num:13, givens:['A','B','b'], asks:['C','a']},
    {num:14, givens:['A','C','c'], asks:['B','a']},
    {num:15, givens:['B','C','c'], asks:['A','b']},
    // SSA (guarded for uniqueness)
    {num:16, givens:['A','a','b'], asks:['B','c'], ssa: {angle:'A', opp:'a', other:'b'}},
    {num:17, givens:['A','a','c'], asks:['C','b'], ssa: {angle:'A', opp:'a', other:'c'}},
    {num:18, givens:['B','b','a'], asks:['A','c'], ssa: {angle:'B', opp:'b', other:'a'}},
    {num:19, givens:['B','b','c'], asks:['C','a'], ssa: {angle:'B', opp:'b', other:'c'}},
    {num:20, givens:['C','c','a'], asks:['A','b'], ssa: {angle:'C', opp:'c', other:'a'}},
    {num:21, givens:['C','c','b'], asks:['B','a'], ssa: {angle:'C', opp:'c', other:'b'}},
  ];

  // Human‑readable labels & units
  const NAMES = { A:'angle A', B:'angle B', C:'angle C', a:'side a', b:'side b', c:'side c' };
  const UNITS = {A:'deg', B:'deg', C:'deg', a:'m', b:'m', c:'m'};

  // Contextual engineering prompts for each of the 21 scenarios
  const SCENARIOS_META = [
    { // 1
      name:'Roof bracing panel',
      intro:'A roof bracing panel links nodes on a truss chord, forming triangle <b>ABC</b>.',
      caption:'Roof bracing (to scale)',
      why:['Determines gusset orientation and bolt edge distances.',
           'Confirms brace geometry against fabrication drawings.',
           'Avoids clashes with purlins and services.']
    },
    { // 2
      name:'Cofferdam struts',
      intro:'Temporary struts inside a cofferdam cell define triangle <b>ABC</b> between walings.',
      caption:'Cofferdam struts (to scale)',
      why:['Verifies plate seating and jack approach angles.',
           'Improves estimation of preload jack stroke.',
           'Supports clash checks with pumps and risers.']
    },
    { // 3
      name:'Survey control triangle',
      intro:'Two known marks and a control point form triangle <b>ABC</b> on site.',
      caption:'Control triangle (to scale)',
      why:['Supports closure checks before works proceed.',
           'Builds confidence in coordinates where GNSS is screened.',
           'Reduces re‑work during set‑out.']
    },
    { // 4
      name:'Guyed mast layout',
      intro:'Two guys and the mast base form triangle <b>ABC</b> in plan.',
      caption:'Guyed mast (to scale)',
      why:['Sets guy spreads clear of services.',
           'Checks feasible turnbuckle ranges.',
           'Assures edge distances at anchors.']
    },
    { // 5
      name:'Bridge tie geometry',
      intro:'A steel tie links anchor points across an approach, forming triangle <b>ABC</b>.',
      caption:'Bridge tie (to scale)',
      why:['Checks tie lengths vs fixing schedule.',
           'Ensures clevis positions maintain clearance.',
           'Confirms temporary clearances during install.']
    },
    { // 6
      name:'Retaining wall anchors',
      intro:'Two soil anchors and the wall toe define triangle <b>ABC</b>.',
      caption:'Anchor fan (to scale)',
      why:['Sets anchor fan spread to avoid utilities.',
           'Helps select plate sizes and turnbuckles.',
           'Ensures movement monitors have clearance.']
    },
    { // 7
      name:'Traverse leg check',
      intro:'Two observed angles and a taped baseline form triangle <b>ABC</b> for a traverse leg.',
      caption:'Traverse check (to scale)',
      why:['Validates angle observations against tape distances.',
           'Provides redundancy for control.',
           'Improves set‑out accuracy near obstructions.']
    },
    { // 8
      name:'Façade corner restraint',
      intro:'Inclined restraints from slab to a façade corner form triangle <b>ABC</b>.',
      caption:'Façade restraint (to scale)',
      why:['Ensures bars clear panels and brackets.',
           'Helps order correct bar lengths.',
           'Coordinates with edge protection fixings.']
    },
    { // 9
      name:'Pipe rack bracing',
      intro:'Diagonal bracing between racks forms triangle <b>ABC</b> around a bay.',
      caption:'Rack bracing (to scale)',
      why:['Confirms brace stock lengths.',
           'Checks clearance to services.',
           'Assists detailing for connections.']
    },
    { // 10
      name:'Roof bay diagonal',
      intro:'Pitched roof members and a diagonal form triangle <b>ABC</b> within a bay.',
      caption:'Roof bay (to scale)',
      why:['Verifies geometry prior to hoisting.',
           'Prevents clashes with M&amp;E.',
           'Supports ordering of bracing kits.']
    },
    { // 11
      name:'Crane tie‑off geometry',
      intro:'A tie‑off point, the jib and a façade corner form triangle <b>ABC</b> in plan.',
      caption:'Crane tie‑off (to scale)',
      why:['Checks reach without oversailing.',
           'Positions exclusion zones.',
           'Supports selection of tie points.']
    },
    { // 12
      name:'Temporary truss check',
      intro:'A temporary truss panel is idealised as triangle <b>ABC</b> for quick checks.',
      caption:'Truss check (to scale)',
      why:['Assesses panel geometry.',
           'Identifies awkward bolt angles.',
           'Reduces adjustments during fit‑up.']
    },
    { // 13
      name:'Edge protection ties',
      intro:'Two ties and a guardrail post form triangle <b>ABC</b>.',
      caption:'Edge protection (to scale)',
      why:['Ensures tie angles keep rails plumb.',
           'Avoids over‑stressing edge anchors.',
           'Confirms safe clearances.']
    },
    { // 14
      name:'Scaffold tie triangle',
      intro:'Two ties and a façade point form triangle <b>ABC</b> around a scaffold bay.',
      caption:'Scaffold ties (to scale)',
      why:['Avoids clashes with openings.',
           'Confirms tie rod stock lengths.',
           'Checks angles against supplier limits.']
    },
    { // 15
      name:'Survey offsets',
      intro:'Two sight lines to an offset peg form triangle <b>ABC</b> on a curve.',
      caption:'Offset triangle (to scale)',
      why:['Speeds chainage checks where GNSS is screened.',
           'Verifies peg positions before paving.',
           'Reduces re‑work.']
    },
    { // 16
      name:'Road alignment offset',
      intro:'A baseline and offset observation create triangle <b>ABC</b> for tie set‑out.',
      caption:'Alignment tie (to scale)',
      why:['Places offset pegs accurately.',
           'Checks visibility around obstructions.',
           'Improves tie geometry ahead of pour.']
    },
    { // 17
      name:'Site lighting stay',
      intro:'A stay cable and two points define triangle <b>ABC</b> near a lighting column.',
      caption:'Stay geometry (to scale)',
      why:['Sets stay spread to avoid footpaths.',
           'Confirms eye bolt ranges.',
           'Checks clearance to signage.']
    },
    { // 18
      name:'Span guying',
      intro:'Guys and a span end form triangle <b>ABC</b>.',
      caption:'Span guying (to scale)',
      why:['Verifies guy angles within supplier limits.',
           'Assures base plate edge distances.',
           'Helps plan installation sequence.']
    },
    { // 19
      name:'Sheet pile tie‑back',
      intro:'A tie‑rod from a waling to an anchor and the toe form triangle <b>ABC</b>.',
      caption:'Tie‑back triangle (to scale)',
      why:['Confirms tie lengths vs design.',
           'Reduces time near open excavations.',
           'Helps avoid utilities behind the wall.']
    },
    { // 20
      name:'Crane reach triangle',
      intro:'The jib, hook path and a façade corner define triangle <b>ABC</b>.',
      caption:'Crane reach (to scale)',
      why:['Checks reach/compliance.',
           'Positions lifting points.',
           'Screens oversail risks.']
    },
    { // 21
      name:'Portal frame fly‑brace',
      intro:'A fly‑brace between rafter and column forms triangle <b>ABC</b>.',
      caption:'Fly‑brace (to scale)',
      why:['Confirms brace length against stock.',
           'Positions hole centres in plates.',
           'Ensures clearances to purlins.']
    },
  ];

  function valueOf(T, key){ return T[key]; }

  function givenText(T, givens){
    const bits = givens.map(k=>{
      const v = valueOf(T,k);
      const s = (k==='A'||k==='B'||k==='C') ? `${to2(v)}°` : `${to2(v)} m`;
      return `<b>${k} = ${s}</b>`;
    });
    return bits.join(', ');
  }

  function askPretty(asks){
    return asks.map(k => (k==='A'||k==='B'||k==='C')? `angle <b>${k}</b>` : `side <b>${k}</b>`).join(' and ');
  }

  function labelsForFigure(T, givens){
    const obj={a:null,b:null,c:null};
    ['a','b','c'].forEach(k=>{
      obj[k] = givens.includes(k) ? `${k} = ${to2(T[k])} m` : `${k} = ?`;
    });
    return obj;
  }

  function scenarioPredicate(def){
    if(!def.ssa) return (T)=>notRight(T.A,T.B,T.C);
    return (T)=>{
      if(!notRight(T.A,T.B,T.C)) return false;
      const {angle, opp, other} = def.ssa;
      return ssaUnique(T[angle], T[opp], T[other]);
    };
  }

  function makeScenario(def){
    const T = triangleFor(scenarioPredicate(def));
    const meta = SCENARIOS_META[def.num-1];
    const labels = labelsForFigure(T, def.givens);
    const fig = svgOblique(T.a, T.b, T.c, labels, meta.caption, pickTriClass());

    const statementHTML = lines([
      meta.intro,
      `Known values: ${givenText(T, def.givens)}.`,
      `Find ${askPretty(def.asks)}.`,
      fig
    ]);

    const parts = def.asks.map(k=>({ prompt: NAMES[k], unit: UNITS[k], val: T[k] }));

    return {
      title: `${meta.name} — find ${def.asks.join(' and ')} from ${def.givens.join(', ')}`,
      statementHTML,
      whyHTML:`<ul>${meta.why.map(x=>`<li>${x}</li>`).join('')}</ul>`,
      parts
    };
  }

  /* ========= Pool & engine ========= */
  const GENERATORS = scenarioDefs.map(def => ()=>makeScenario(def));

  let QUESTIONS=[], BATCH=10, idx=0, score=0;
  let nameStr='Student', mode='timed', timeLeft=0, timerId=null, target=0, correctSoFar=0, unlimited=false;
  let currentQ=null;

  const el = id=>document.getElementById(id);
  const $qCard=el('qCard');
  const $endCard=el('endCard');
  const $qTitle=el('qTitle'), $statement=el('statement'), $whyHtml=el('whyHtml');
  const $scoreTopVal=el('scoreTopVal'), $modeTxt=el('modeTxt'), $timeTxt=el('timeTxt');

  function buildSet(n){
    const gens=[...GENERATORS], qs=[];
    for(let i=0;i<n;i++){
      const g = gens.length ? gens.splice(Math.floor(Math.random()*gens.length),1)[0]
                            : GENERATORS[Math.floor(Math.random()*GENERATORS.length)];
      const q = g();
      qs.push(q);
    }
    return qs;
  }

  function updateTop(){
    el('whoName').textContent = nameStr || 'Student';
    $modeTxt.textContent = mode==='timed' ? 'Timed' : 'Target';
    $scoreTopVal.textContent = `${score} / ${idx}`;
    $timeTxt.textContent = (mode==='timed' && !unlimited) ? secsToMMSS(timeLeft) : '—';
  }

  function startTimer(){
    if(mode!=='timed' || unlimited) return;
    clearInterval(timerId);
    $timeTxt.textContent = secsToMMSS(timeLeft);
    timerId = setInterval(()=>{
      if(timeLeft <= 1){
        timeLeft = 0;
        $timeTxt.textContent = secsToMMSS(timeLeft);
        clearInterval(timerId);
        finish('Time’s up!');
      }else{
        timeLeft -= 1;
        $timeTxt.textContent = secsToMMSS(timeLeft);
      }
    },1000);
  }

  function startWorksheet(){
    BATCH = parseInt(document.getElementById('qtyInput').value,10);
    QUESTIONS = buildSet(BATCH);
    idx=0; score=0; correctSoFar=0;
    $endCard.style.display='none';
    $qCard.style.display='block';
    renderQ();
    updateTop();
    if(window.MathJax && window.MathJax.typeset){ MathJax.typeset(); }
    startTimer();
  }

  function finish(message='Well done!'){
    clearInterval(timerId);
    $qCard.style.display='none';
    $endCard.style.display='block';
    el('endMsg').textContent = message;
    el('sumName').textContent = nameStr || 'Student';
    el('sumMode').textContent = ($modeTxt.textContent);
    el('sumScore').textContent = `${score} / ${idx}`;
    const tSel = document.querySelector('input[name="tlimit"]:checked')?.value||'0';
    const setTime = (mode==='timed' && !unlimited) ? parseInt(tSel,10) : 0;
    const usedSecs = (mode==='timed' && !unlimited) ? (setTime - timeLeft) : 0;
    el('sumTime').textContent = (mode==='timed' && !unlimited) ? secsToMMSS(Math.max(0,usedSecs)) : '—';
  }

  function progressText(){
    return (mode==='timed') ? `Question ${idx+1}` : `Question ${idx+1} · Target ${correctSoFar}/${target}`;
  }

  function renderQ(){
    const local = idx % QUESTIONS.length;
    currentQ = QUESTIONS[local];
    document.getElementById('progress').textContent = progressText();
    $qTitle.textContent = currentQ.title;
    $statement.innerHTML = currentQ.statementHTML;
    $whyHtml.innerHTML = currentQ.whyHTML || '';
    buildIORows(currentQ.parts);
    document.getElementById('nextBtn').disabled = true;
    $scoreTopVal.textContent = `${score} / ${idx}`;
    if(window.MathJax && window.MathJax.typeset){ MathJax.typeset(); }
  }

  function checkCurrent(){
    const parts = currentQ.parts;
    let allOK=true;
    parts.forEach((p,i)=>{
      const inp = document.getElementById('ans-'+i);
      const mark = document.getElementById('mark-'+i);
      const fb = document.getElementById('fb-'+i);
      const stu = parseNum(inp && inp.value);
      if(isFinite(stu)) inp.value = to2(stu);
      if(isFinite(stu) && within09(stu, p.val)){
        mark.textContent='✓'; mark.className='marker ok'; fb.textContent='';
      }else{
        mark.textContent='✗'; mark.className='marker no';
        fb.innerHTML = `Ans: <span class="ans">${to2(p.val)} ${unit(p.unit)}</span>`;
        allOK=false;
      }
      inp.disabled=true;
    });
    if(allOK){ score++; correctSoFar++; }
    $scoreTopVal.textContent = `${score} / ${idx+1}`;
    document.getElementById('nextBtn').disabled=false;
    if(mode==='target' && correctSoFar>=target){ finish('Target achieved!'); }
  }

  function nextQ(){
    idx++;
    if(idx % QUESTIONS.length === 0){
      QUESTIONS = buildSet(BATCH);
    }
    renderQ();
    updateTop();
  }

  // Events
  document.getElementById('checkBtn').addEventListener('click', checkCurrent);
  document.getElementById('nextBtn').addEventListener('click', nextQ);
  document.getElementById('newBtn').addEventListener('click', ()=>{
    clearInterval(timerId);
    document.getElementById('startModal').style.display='flex';
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !document.getElementById('nextBtn').disabled){ nextQ(); }
    else if(e.key==='Enter' && document.getElementById('nextBtn').disabled){ checkCurrent(); }
  });

  function updateModeFields(){
    const modeEl = document.querySelector('input[name="mode"]:checked');
    const modeVal = modeEl ? modeEl.value : 'timed';
    document.getElementById('timedField').style.display = (modeVal==='timed') ? '' : 'none';
    document.getElementById('targetField').style.display = (modeVal==='target') ? '' : 'none';
  }
  document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change', updateModeFields));

  // START button
  document.getElementById('startBtn').addEventListener('click', ()=>{
    nameStr = document.getElementById('nameInput').value.trim() || 'Student';
    const picked = document.querySelector('input[name="mode"]:checked');
    mode = picked ? picked.value : 'timed';

    if(mode==='timed'){
      const sel = parseInt(document.querySelector('input[name="tlimit"]:checked')?.value||'1200',10);
      unlimited = (sel===0);
      timeLeft = unlimited ? 0 : sel;
    }else{
      unlimited = false;
      timeLeft = 0;
      target = clamp(parseInt(document.getElementById('targetInput').value,10)||10,1,1000000);
    }

    document.getElementById('modeTxt').textContent = mode==='timed' ? 'Timed' : 'Target';
    document.getElementById('timeTxt').textContent = (mode==='timed' && !unlimited) ? secsToMMSS(timeLeft) : '—';

    // Start
    document.getElementById('startModal').style.display='none';
    startWorksheet();
  });

  document.getElementById('restartBtn').addEventListener('click', ()=>{
    clearInterval(timerId);
    document.getElementById('startModal').style.display='flex';
  });
  updateModeFields();

  // Fullscreen
  document.getElementById('fsBtn').addEventListener('click', ()=>{
    if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); }
    else{ document.exitFullscreen?.(); }
  });
  document.addEventListener('fullscreenchange', ()=>{
    document.getElementById('fsBtn').textContent = document.fullscreenElement ? '✕ Exit full screen' : '⛶ Full screen';
  });

  // Show modal on load
  document.getElementById('startModal').style.display='flex';
});
</script>
</body>
</html>
